#!/usr/bin/env python3

import subprocess
import sys
from pathlib import Path

def run_cmd(cmd, check=True):
    """åŸ·è¡Œå‘½ä»¤ä¸¦å›å‚³çµæœ"""
    try:
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True, check=check)
        return result.returncode == 0, result.stdout, result.stderr
    except subprocess.CalledProcessError as e:
        return False, e.stdout, e.stderr

def check_npm_link():
    """æª¢æŸ¥ npm link æ˜¯å¦æœ‰æ•ˆ"""
    print("æª¢æŸ¥ npm link ç‹€æ…‹...")

    # æª¢æŸ¥å…¨åŸŸ npm æ¨¡çµ„ä¸­æ˜¯å¦æœ‰ karabiner-ts-config
    success, stdout, _ = run_cmd("npm ls -g --depth=0 karabiner-ts-config", check=False)

    if not success or "karabiner-ts-config" not in stdout:
        print("âš ï¸  æœªæ‰¾åˆ° npm linkï¼Œæ­£åœ¨å»ºç«‹...")
        success, _, stderr = run_cmd("npm link")
        if not success:
            print(f"âŒ npm link å¤±æ•—: {stderr}")
            return False
        print("âœ… npm link å»ºç«‹æˆåŠŸ")
    else:
        print("âœ… npm link å·²å­˜åœ¨")

    return True

def run_karabiner_config(config_file="./example/raz.ts"):
    """åŸ·è¡Œ karabiner-ts-config æŒ‡ä»¤"""
    print(f"\nåŸ·è¡Œè¨­å®šæª”: {config_file}")

    # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    if not Path(config_file).exists():
        print(f"âŒ æ‰¾ä¸åˆ°è¨­å®šæª”: {config_file}")
        return False

    # åŸ·è¡ŒæŒ‡ä»¤
    cmd = f"node dist/bin/cli.js {config_file} -y"
    success, stdout, stderr = run_cmd(cmd)

    if success:
        print(stdout)
        return True
    else:
        print("âŒ åŸ·è¡Œå¤±æ•—:")
        if stderr:
            print(stderr)
        return False

def publish_npm(otp=None):
    """ç™¼ä½ˆè‡³ npmjs"""
    print("\nç™¼ä½ˆè‡³ npmjs...")
    cmd = "npm publish --access public"
    if otp:
        cmd += f" --otp={otp}"
    success, stdout, stderr = run_cmd(cmd)
    if success:
        print("âœ… ç™¼ä½ˆæˆåŠŸ")
        print(stdout)
        return True
    else:
        print(f"âŒ ç™¼ä½ˆå¤±æ•—: {stderr}")
        return False

def main():
    """ä¸»ç¨‹å¼"""
    print("ğŸš€ Karabiner TypeScript Config Runner")
    print("=" * 40)

    # æª¢æŸ¥æ˜¯å¦åœ¨å°ˆæ¡ˆç›®éŒ„
    if not Path("package.json").exists():
        print("âŒ è«‹åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œæ­¤è…³æœ¬")
        sys.exit(1)

    # å»ºæ§‹å°ˆæ¡ˆ
    print("\nå»ºæ§‹å°ˆæ¡ˆ...")
    success, _, stderr = run_cmd("npm run build")
    if not success:
        print(f"âŒ å»ºæ§‹å¤±æ•—: {stderr}")
        sys.exit(1)
    print("âœ… å»ºæ§‹æˆåŠŸ")

    # æª¢æŸ¥ -pub åƒæ•¸
    if "-pub" in sys.argv:
        otp = None
        for arg in sys.argv:
            if arg.startswith("-otp="):
                otp = arg.split("=")[1]
        if not otp:
            otp = input("è«‹è¼¸å…¥ OTP: ").strip()
        if not publish_npm(otp):
            sys.exit(1)
        print("\nâœ¨ å®Œæˆï¼å·²ç™¼ä½ˆè‡³ npmjs")
        return

    # æª¢æŸ¥ npm link
    if not check_npm_link():
        sys.exit(1)

    # åŸ·è¡Œè¨­å®š
    args = [a for a in sys.argv[1:] if not a.startswith("-")]
    config_file = args[0] if args else "./example/raz.ts"
    if not run_karabiner_config(config_file):
        sys.exit(1)

    print("\nâœ¨ å®Œæˆï¼Karabiner è¨­å®šå·²æ›´æ–°")

if __name__ == "__main__":
    main()
